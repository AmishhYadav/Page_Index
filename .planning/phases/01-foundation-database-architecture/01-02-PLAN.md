---
wave: 2
depends_on: ["01-01-PLAN.md"]
files_modified: ["app/db/session.py", "app/models/base.py", "app/models/document.py", "alembic.ini", "alembic/env.py"]
autonomous: true
requirements: ["IDX-04"]
---

# Plan 01-02: PostgreSQL & Strict Hierarchy Models

## Goal
Implement PostgreSQL connection, SQLAlchemy models with strict Document -> Page -> Section cascading invariants, and Alembic migrations.

<tasks>
  <task id="1" title="Setup Database Session">
    <description>Create `app/db/session.py` initializing the SQLAlchemy `create_engine` and `sessionmaker` using the `POSTGRES_URL` from the Pydantic configuration.</description>
  </task>
  <task id="2" title="Define SQLAlchemy Models">
    <description>Create models in `app/models/document.py`. Define `Document` (PK UUID), `Page` (PK UUID, FK `document_id` with `ondelete='CASCADE'`, `page_number`), and `Section` (PK UUID, FK `page_id` with `ondelete='CASCADE'`, `section_index`, `content`). Add `UniqueConstraint('document_id', 'page_number')` to `Page` and `UniqueConstraint('page_id', 'section_index')` to `Section`.</description>
  </task>
  <task id="3" title="Initialize Alembic Migrations">
    <description>Run `alembic init alembic`. Configure `alembic/env.py` to import `Base` from `app.models.base` and point `sqlalchemy.url` to the config `POSTGRES_URL`.</description>
  </task>
  <task id="4" title="Generate Initial Migration">
    <description>Generate the initial alembic revision script for the `Document`, `Page`, and `Section` tables to establish the schema constraints.</description>
  </task>
</tasks>

<verification>
1. Alembic generates migration file matching the expected models.
2. PostgreSQL database receives the schema without errors upon `alembic upgrade head`.
</verification>

<must_haves>
- SQLAlchemy models (Document, Page, Section) enforce strict hierarchy.
- Foreign keys use `ondelete='CASCADE'`.
- Database connection managed correctly without application-level logic for orphan prevention.
</must_haves>
