---
wave: 3
depends_on: ["02-01-PLAN.md", "02-02-PLAN.md"]
files_modified: ["app/services/ingestion.py", "app/api/v1/documents.py"]
autonomous: true
requirements: ["IDX-01", "IDX-02", "IDX-03", "IDX-05"]
---

# Plan 02-03: Hierarchical Database Sync

## Goal
Orchestrate the atomic write to PostgreSQL and subsequent vector upsert to Qdrant, ensuring primary key linkage.

<tasks>
  <task id="1" title="Build Ingestion Orchestrator">
    <description>Create `app/services/ingestion.py`. Implement a function that takes the structured data from `pdf_processor`, performs a single Postgres transaction (Insert Document -> Pages -> Sections), then iterates through the created Section rows to generate embeddings and upsert to Qdrant using the Section UUID as the point ID.</description>
  </task>
  <task id="2" title="Wired API to Orchestrator">
    <description>Update `app/api/v1/documents.py` to invoke the ingestion orchestrator. Ensure observability logs capture success/failure metrics for both Postgres and Qdrant operations.</description>
  </task>
</tasks>

<verification>
1. Uploading a PDF results in a new Document entry in Postgres with all associated Pages and Sections.
2. Qdrant contains the same number of points as Sections in Postgres, with matching UUIDs.
3. Observability logs show `ingestion_total_latency` and individual DB write latency.
</verification>

<must_haves>
- Hierarchical write to Postgres is completed before Qdrant writes.
- Section UUID is used as the key for Qdrant point IDs (enforcing the canonical link).
- Proper use of the configured `EmbeddingProvider` for vector generation.
</must_haves>
