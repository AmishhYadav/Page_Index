# Plan 04-02: Metadata-Aware Filtering

## Goal
Allow users to scope retrieval to specific documents, page ranges, or date ranges by passing filters through the `/ask` endpoint.

<tasks>
  <task id="1" title="Extend AskRequest Schema">
    <description>Update `app/schemas/ask.py` to add optional filter fields:
    - `document_ids: Optional[List[UUID]]`
    - `filename_contains: Optional[str]`
    - `page_range: Optional[Tuple[int, int]]`
    - `created_after: Optional[datetime]`</description>
  </task>
  <task id="2" title="Add Qdrant Filter Construction">
    <description>In `app/services/retrieval.py`, build a `qdrant_client.http.models.Filter` from the request filters. Map `document_ids` to payload `document_id`, `page_range` to payload `page_number`.</description>
  </task>
  <task id="3" title="Add Postgres WHERE Clause">
    <description>In the BM25 retriever and the hierarchy join, apply equivalent SQLAlchemy filters so that BM25 results and canonical fetches respect the same scope.</description>
  </task>
  <task id="4" title="Verification">
    <description>Write a test that ingests 2 documents, filters to one, and asserts that only sections from the filtered document appear in results.</description>
  </task>
</tasks>

<verification>
1. Qdrant search respects payload filters.
2. BM25 search respects Postgres WHERE filters.
3. Unfiltered searches continue to work (backward compatible).
</verification>

<must_haves>
- Filters are optional â€” default behavior is unfiltered.
- Invalid filter values return clear 422 validation errors.
</must_haves>
